"use strict";(self.webpackChunkimdeepmind=self.webpackChunkimdeepmind||[]).push([[6139],{89757:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>t,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"databases/database-engineering/transactions","title":"Transactions","description":"This note is complete, reviewed, and considered stable.","source":"@site/docs/databases/database-engineering/transactions.md","sourceDirName":"databases/database-engineering","slug":"/databases/database-engineering/transactions","permalink":"/docs/databases/database-engineering/transactions","draft":false,"unlisted":false,"editUrl":"https://github.com/imdeepmind/imdeepmind.github.io/blob/main/docs/databases/database-engineering/transactions.md","tags":[],"version":"current","lastUpdatedBy":"Abhishek Chatterjee","lastUpdatedAt":1768499314000,"sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"Connection Pooling","permalink":"/docs/databases/database-engineering/pooling"},"next":{"title":"ACID","permalink":"/docs/databases/database-engineering/acid"}}');var r=s(74848),l=s(28453);const t={sidebar_position:3},a="Transactions",c={},o=[{value:"Why transactions exist",id:"why-transactions-exist",level:2},{value:"Transaction lifecycle (high level)",id:"transaction-lifecycle-high-level",level:2},{value:"ACID properties (what transactions guarantee)",id:"acid-properties-what-transactions-guarantee",level:2},{value:"Atomicity \u2013 all or nothing",id:"atomicity--all-or-nothing",level:2},{value:"Atomicity internally",id:"atomicity-internally",level:3},{value:"Consistency \u2013 rules are enforced",id:"consistency--rules-are-enforced",level:2},{value:"Isolation \u2013 transactions don\u2019t interfere",id:"isolation--transactions-dont-interfere",level:2},{value:"Dirty read example (bad)",id:"dirty-read-example-bad",level:3},{value:"Durability \u2013 committed means permanent",id:"durability--committed-means-permanent",level:2},{value:"Transactions and connections (critical relationship)",id:"transactions-and-connections-critical-relationship",level:2},{value:"How transactions work internally (real mechanism)",id:"how-transactions-work-internally-real-mechanism",level:2},{value:"Transaction start (BEGIN internally)",id:"transaction-start-begin-internally",level:2},{value:"Write-Ahead Logging (WAL)",id:"write-ahead-logging-wal",level:2},{value:"Core rule",id:"core-rule",level:3},{value:"UPDATE internally",id:"update-internally",level:3},{value:"COMMIT internally",id:"commit-internally",level:2},{value:"ROLLBACK internally",id:"rollback-internally",level:2},{value:"MVCC \u2013 how isolation really works",id:"mvcc--how-isolation-really-works",level:2},{value:"Snapshots and visibility",id:"snapshots-and-visibility",level:2},{value:"Locks (still necessary, but limited)",id:"locks-still-necessary-but-limited",level:2},{value:"Crash recovery",id:"crash-recovery",level:2},{value:"Garbage collection of old versions",id:"garbage-collection-of-old-versions",level:2},{value:"Why long transactions are dangerous",id:"why-long-transactions-are-dangerous",level:2},{value:"Mental model",id:"mental-model",level:2}];function d(n){const e={admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"transactions",children:"Transactions"})}),"\n",(0,r.jsx)(e.admonition,{title:"Status",type:"tip",children:(0,r.jsx)(e.p,{children:"This note is complete, reviewed, and considered stable."})}),"\n",(0,r.jsxs)(e.p,{children:["A ",(0,r.jsx)(e.strong,{children:"transaction"})," is a sequence of database operations that the database treats as ",(0,r.jsx)(e.strong,{children:"one logical unit"}),"."]}),"\n",(0,r.jsx)(e.p,{children:"A transaction guarantees:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["Either ",(0,r.jsx)(e.strong,{children:"all operations succeed"})]}),"\n",(0,r.jsxs)(e.li,{children:["Or ",(0,r.jsx)(e.strong,{children:"none of them take effect"})]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["There is ",(0,r.jsx)(e.strong,{children:"no visible partial state"}),"."]}),"\n",(0,r.jsx)(e.h2,{id:"why-transactions-exist",children:"Why transactions exist"}),"\n",(0,r.jsxs)(e.p,{children:["Databases operate in an environment where ",(0,r.jsx)(e.strong,{children:"failures and concurrency are normal"}),":"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Multiple users updating data at the same time"}),"\n",(0,r.jsx)(e.li,{children:"Application crashes"}),"\n",(0,r.jsx)(e.li,{children:"Database crashes"}),"\n",(0,r.jsx)(e.li,{children:"Partial execution of multi-step logic"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["Without transactions, databases would constantly end up in ",(0,r.jsx)(e.strong,{children:"corrupted or inconsistent states"}),"."]}),"\n",(0,r.jsx)(e.p,{children:"Example problem:"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-text",children:"1. Deduct \u20b91000 from Account A  - executed successfully\n2. Add \u20b91000 to Account B       - db crahsed\n"})}),"\n",(0,r.jsx)(e.p,{children:"Money disappears."}),"\n",(0,r.jsx)(e.p,{children:"Transactions exist to guarantee:"}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Multiple operations behave as one correct, indivisible unit of work."})}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"transaction-lifecycle-high-level",children:"Transaction lifecycle (high level)"}),"\n",(0,r.jsx)("div",{style:{textAlign:"center"},children:(0,r.jsx)(e.mermaid,{value:"stateDiagram-v2\n    [*] --\x3e Active\n    Active --\x3e Committed\n    Active --\x3e RolledBack\n    Committed --\x3e [*]\n    RolledBack --\x3e [*]"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"BEGIN"})," \u2192 transaction becomes ",(0,r.jsx)(e.strong,{children:"Active"})]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"COMMIT"})," \u2192 changes become permanent"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"ROLLBACK"})," \u2192 changes are undone"]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"acid-properties-what-transactions-guarantee",children:"ACID properties (what transactions guarantee)"}),"\n",(0,r.jsxs)(e.p,{children:["Transactions are defined by ",(0,r.jsx)(e.strong,{children:"ACID"}),". These are ",(0,r.jsx)(e.strong,{children:"engineering guarantees"}),", not theory."]}),"\n",(0,r.jsx)(e.h2,{id:"atomicity--all-or-nothing",children:"Atomicity \u2013 all or nothing"}),"\n",(0,r.jsx)(e.p,{children:"Atomicity means:"}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsx)(e.p,{children:"A transaction is indivisible. Partial results are never visible."}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Example:"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"BEGIN;\nUPDATE accounts SET balance = balance - 100 WHERE id = 1;\nUPDATE accounts SET balance = balance + 100 WHERE id = 2;\nCOMMIT;\n"})}),"\n",(0,r.jsxs)(e.p,{children:["If the second update fails, the first update is ",(0,r.jsx)(e.strong,{children:"undone"}),"."]}),"\n",(0,r.jsx)(e.h3,{id:"atomicity-internally",children:"Atomicity internally"}),"\n",(0,r.jsx)(e.p,{children:"Databases achieve atomicity using:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.strong,{children:"Undo information"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.strong,{children:"Transaction logs"})}),"\n"]}),"\n",(0,r.jsx)("div",{style:{textAlign:"center"},children:(0,r.jsx)(e.mermaid,{value:"flowchart LR\n    Tx[Transaction]\n    Change[Data Change]\n    Undo[Undo / Old Value]\n\n    Tx --\x3e Change\n    Change --\x3e Undo"})}),"\n",(0,r.jsx)(e.p,{children:"If the transaction aborts, the database reverts changes using undo data."}),"\n",(0,r.jsx)(e.h2,{id:"consistency--rules-are-enforced",children:"Consistency \u2013 rules are enforced"}),"\n",(0,r.jsx)(e.p,{children:"Consistency means:"}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsxs)(e.p,{children:["A transaction moves the database from one ",(0,r.jsx)(e.strong,{children:"valid state"})," to another ",(0,r.jsx)(e.strong,{children:"valid state"}),"."]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Examples of consistency rules:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Foreign keys must exist"}),"\n",(0,r.jsx)(e.li,{children:"Unique constraints must hold"}),"\n",(0,r.jsx)(e.li,{children:"Balance must not be negative"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"If a transaction violates constraints:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["The database ",(0,r.jsx)(e.strong,{children:"rejects it"})]}),"\n",(0,r.jsx)(e.li,{children:"The transaction is rolled back"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Important:"}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsxs)(e.p,{children:["Transactions do not define rules, ",(0,r.jsx)(e.strong,{children:"constraints do"}),".\nTransactions ensure rules are never bypassed."]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"isolation--transactions-dont-interfere",children:"Isolation \u2013 transactions don\u2019t interfere"}),"\n",(0,r.jsx)(e.p,{children:"Isolation means:"}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsxs)(e.p,{children:["Concurrent transactions must not see each other\u2019s ",(0,r.jsx)(e.strong,{children:"partial work"}),"."]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Without isolation, anomalies occur."}),"\n",(0,r.jsx)(e.h3,{id:"dirty-read-example-bad",children:"Dirty read example (bad)"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-text",children:"T1: UPDATE balance = balance - 500 (not committed)\nT2: SELECT balance \u2192 sees reduced balance\nT1: ROLLBACK\n"})}),"\n",(0,r.jsxs)(e.p,{children:["T2 observed data that ",(0,r.jsx)(e.strong,{children:"never existed"}),"."]}),"\n",(0,r.jsx)(e.p,{children:"Isolation prevents this."}),"\n",(0,r.jsx)(e.h2,{id:"durability--committed-means-permanent",children:"Durability \u2013 committed means permanent"}),"\n",(0,r.jsx)(e.p,{children:"Durability means:"}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsx)(e.p,{children:"Once a transaction commits, its changes will survive crashes."}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Databases achieve durability using:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Write-Ahead Logging (WAL)"}),"\n",(0,r.jsx)(e.li,{children:"fsync to stable storage"}),"\n",(0,r.jsx)(e.li,{children:"Crash recovery"}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"transactions-and-connections-critical-relationship",children:"Transactions and connections (critical relationship)"}),"\n",(0,r.jsxs)(e.p,{children:["A transaction is ",(0,r.jsx)(e.strong,{children:"always bound to one database connection"}),"."]}),"\n",(0,r.jsx)("div",{style:{textAlign:"center"},children:(0,r.jsx)(e.mermaid,{value:"flowchart LR\n    Conn[DB Connection]\n    Tx[Transaction Context]\n    DB[(Database)]\n\n    Conn --\x3e Tx --\x3e DB"})}),"\n",(0,r.jsx)(e.p,{children:"Implications:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"A transaction cannot span multiple connections"}),"\n",(0,r.jsxs)(e.li,{children:["The connection is held until ",(0,r.jsx)(e.code,{children:"COMMIT"})," or ",(0,r.jsx)(e.code,{children:"ROLLBACK"})]}),"\n",(0,r.jsx)(e.li,{children:"This is why long transactions exhaust connection pools"}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"how-transactions-work-internally-real-mechanism",children:"How transactions work internally (real mechanism)"}),"\n",(0,r.jsxs)(e.p,{children:["Internally, transactions rely on ",(0,r.jsx)(e.strong,{children:"four core systems"}),":"]}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"Transaction IDs (TXID)"}),"\n",(0,r.jsx)(e.li,{children:"Write-Ahead Logging (WAL)"}),"\n",(0,r.jsx)(e.li,{children:"MVCC (row versioning)"}),"\n",(0,r.jsx)(e.li,{children:"Locks (minimal and scoped)"}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"transaction-start-begin-internally",children:"Transaction start (BEGIN internally)"}),"\n",(0,r.jsx)(e.p,{children:"When you run:"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"BEGIN;\n"})}),"\n",(0,r.jsx)(e.p,{children:"The database:"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:["Assigns a ",(0,r.jsx)(e.strong,{children:"Transaction ID (TXID)"})]}),"\n",(0,r.jsxs)(e.li,{children:["Creates a ",(0,r.jsx)(e.strong,{children:"transaction context"})]}),"\n",(0,r.jsx)(e.li,{children:"Records snapshot information"}),"\n"]}),"\n",(0,r.jsx)("div",{style:{textAlign:"center"},children:(0,r.jsx)(e.mermaid,{value:"flowchart LR\n    Client --\x3e Conn[Connection]\n    Conn --\x3e Tx[Transaction\\nTXID=42]"})}),"\n",(0,r.jsx)(e.p,{children:"No data is copied. No locks are taken yet."}),"\n",(0,r.jsx)(e.h2,{id:"write-ahead-logging-wal",children:"Write-Ahead Logging (WAL)"}),"\n",(0,r.jsx)(e.h3,{id:"core-rule",children:"Core rule"}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Changes must be written to the log before data pages are modified."})}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Why?"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Logs are sequential \u2192 fast"}),"\n",(0,r.jsx)(e.li,{children:"Logs are replayable \u2192 crash-safe"}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"update-internally",children:"UPDATE internally"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"UPDATE users SET balance = 900 WHERE id = 1;\n"})}),"\n",(0,r.jsx)(e.p,{children:"Steps:"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"Create WAL record (old value, new value, TXID)"}),"\n",(0,r.jsx)(e.li,{children:"Append WAL record to disk"}),"\n",(0,r.jsx)(e.li,{children:"Modify data page in memory"}),"\n",(0,r.jsx)(e.li,{children:"Mark page as dirty"}),"\n"]}),"\n",(0,r.jsx)("div",{style:{textAlign:"center"},children:(0,r.jsx)(e.mermaid,{value:"sequenceDiagram\n    participant Tx as Transaction\n    participant WAL as WAL Log\n    participant Mem as Memory Page\n    participant Disk as Disk\n\n    Tx->>WAL: Write change record\n    WAL->>Disk: fsync\n    Tx->>Mem: Apply change\n    Mem--\x3e>Tx: Page marked dirty"})}),"\n",(0,r.jsx)(e.h2,{id:"commit-internally",children:"COMMIT internally"}),"\n",(0,r.jsxs)(e.p,{children:["When ",(0,r.jsx)(e.code,{children:"COMMIT"})," is issued:"]}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"Write COMMIT record to WAL"}),"\n",(0,r.jsx)(e.li,{children:"Flush WAL to disk"}),"\n",(0,r.jsx)(e.li,{children:"Mark transaction as committed"}),"\n",(0,r.jsx)(e.li,{children:"Release locks"}),"\n",(0,r.jsx)(e.li,{children:"Make versions visible"}),"\n"]}),"\n",(0,r.jsx)("div",{style:{textAlign:"center"},children:(0,r.jsx)(e.mermaid,{value:"flowchart TB\n    Tx --\x3e WAL\n    WAL --\x3e Disk\n    Disk --\x3e Tx"})}),"\n",(0,r.jsx)(e.p,{children:"At this point:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["Transaction is ",(0,r.jsx)(e.strong,{children:"durable"})]}),"\n",(0,r.jsx)(e.li,{children:"Crashes cannot undo it"}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"rollback-internally",children:"ROLLBACK internally"}),"\n",(0,r.jsxs)(e.p,{children:["When ",(0,r.jsx)(e.code,{children:"ROLLBACK"})," happens:"]}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"Use undo / old versions"}),"\n",(0,r.jsx)(e.li,{children:"Revert in-memory changes"}),"\n",(0,r.jsx)(e.li,{children:"Discard transaction context"}),"\n"]}),"\n",(0,r.jsx)("div",{style:{textAlign:"center"},children:(0,r.jsx)(e.mermaid,{value:"flowchart LR\n    Tx --\x3e Undo[Undo Data] --\x3e Data[Restore Old State]"})}),"\n",(0,r.jsx)(e.p,{children:"No durability guarantee is needed for rollback."}),"\n",(0,r.jsx)(e.h2,{id:"mvcc--how-isolation-really-works",children:"MVCC \u2013 how isolation really works"}),"\n",(0,r.jsxs)(e.p,{children:["Modern databases use ",(0,r.jsx)(e.strong,{children:"MVCC (Multi-Version Concurrency Control)"}),"."]}),"\n",(0,r.jsx)(e.p,{children:"Instead of overwriting rows:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["Updates create ",(0,r.jsx)(e.strong,{children:"new versions"})]}),"\n",(0,r.jsx)(e.li,{children:"Old versions remain for other transactions"}),"\n"]}),"\n",(0,r.jsx)("div",{style:{textAlign:"center"},children:(0,r.jsx)(e.mermaid,{value:"flowchart LR\n    V1[Row v1\\nTXID=10]\n    V2[Row v2\\nTXID=20]\n    V3[Row v3\\nTXID=30]\n\n    V1 --\x3e V2 --\x3e V3"})}),"\n",(0,r.jsx)(e.h2,{id:"snapshots-and-visibility",children:"Snapshots and visibility"}),"\n",(0,r.jsxs)(e.p,{children:["Each transaction gets a ",(0,r.jsx)(e.strong,{children:"snapshot"}),":"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Which transactions were committed"}),"\n",(0,r.jsx)(e.li,{children:"Which were active"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"When reading a row:"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-text",children:"Is this version visible to my snapshot?\n\u2192 Yes \u2192 return\n\u2192 No \u2192 skip\n"})}),"\n",(0,r.jsxs)(e.p,{children:["Reads do ",(0,r.jsx)(e.strong,{children:"not block writes"}),"."]}),"\n",(0,r.jsx)(e.h2,{id:"locks-still-necessary-but-limited",children:"Locks (still necessary, but limited)"}),"\n",(0,r.jsx)(e.p,{children:"Despite MVCC, locks exist:"}),"\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"Lock"}),(0,r.jsx)(e.th,{children:"Purpose"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Row locks"}),(0,r.jsx)(e.td,{children:"Prevent concurrent writes"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Table locks"}),(0,r.jsx)(e.td,{children:"DDL"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Advisory locks"}),(0,r.jsx)(e.td,{children:"App-level coordination"})]})]})]}),"\n",(0,r.jsx)("div",{style:{textAlign:"center"},children:(0,r.jsx)(e.mermaid,{value:"flowchart LR\n    Tx1 --\x3e|Row Lock| Row\n    Tx2 --\x3e|Wait| Row"})}),"\n",(0,r.jsx)(e.p,{children:"Locks are:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Fine-grained"}),"\n",(0,r.jsx)(e.li,{children:"Short-lived"}),"\n",(0,r.jsx)(e.li,{children:"Scoped to transactions"}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"crash-recovery",children:"Crash recovery"}),"\n",(0,r.jsx)(e.p,{children:"After a crash:"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"Database scans WAL"}),"\n",(0,r.jsx)(e.li,{children:"Replays committed transactions"}),"\n",(0,r.jsx)(e.li,{children:"Ignores uncommitted ones"}),"\n"]}),"\n",(0,r.jsx)("div",{style:{textAlign:"center"},children:(0,r.jsx)(e.mermaid,{value:"flowchart LR\n    Crash --\x3e WAL\n    WAL --\x3e Redo[Redo Committed]\n    WAL --\x3e Skip[Ignore Uncommitted]"})}),"\n",(0,r.jsxs)(e.p,{children:["This guarantees ",(0,r.jsx)(e.strong,{children:"Atomicity + Durability"}),"."]}),"\n",(0,r.jsx)(e.h2,{id:"garbage-collection-of-old-versions",children:"Garbage collection of old versions"}),"\n",(0,r.jsx)(e.p,{children:"Old row versions cannot live forever."}),"\n",(0,r.jsx)(e.p,{children:"Background process:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Removes versions no snapshot needs"}),"\n",(0,r.jsx)(e.li,{children:"Reclaims space"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["(PostgreSQL: ",(0,r.jsx)(e.code,{children:"VACUUM"}),")"]}),"\n",(0,r.jsx)("div",{style:{textAlign:"center"},children:(0,r.jsx)(e.mermaid,{value:"flowchart LR\n    Old[Old Versions] --\x3e GC[Garbage Collector] --\x3e Free[Free Space]"})}),"\n",(0,r.jsx)(e.p,{children:"Long transactions delay cleanup."}),"\n",(0,r.jsx)(e.h2,{id:"why-long-transactions-are-dangerous",children:"Why long transactions are dangerous"}),"\n",(0,r.jsx)(e.p,{children:"Long transactions:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Hold snapshots open"}),"\n",(0,r.jsx)(e.li,{children:"Prevent garbage collection"}),"\n",(0,r.jsx)(e.li,{children:"Hold connections"}),"\n",(0,r.jsx)(e.li,{children:"Increase WAL size"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"This leads to:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Pool exhaustion"}),"\n",(0,r.jsx)(e.li,{children:"Disk bloat"}),"\n",(0,r.jsx)(e.li,{children:"Latency spikes"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Rule:"}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Start transactions late, commit early."})}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"mental-model",children:"Mental model"}),"\n",(0,r.jsx)(e.p,{children:"Think of a transaction as:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["A ",(0,r.jsx)(e.strong,{children:"private snapshot"})]}),"\n",(0,r.jsxs)(e.li,{children:["A ",(0,r.jsx)(e.strong,{children:"stream of logged changes"})]}),"\n",(0,r.jsxs)(e.li,{children:["A set of ",(0,r.jsx)(e.strong,{children:"new row versions"})]}),"\n",(0,r.jsxs)(e.li,{children:["A ",(0,r.jsx)(e.strong,{children:"temporary ownership of a connection"})]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Other transactions never see half-finished work."})]})}function h(n={}){const{wrapper:e}={...(0,l.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(d,{...n})}):d(n)}},28453:(n,e,s)=>{s.d(e,{R:()=>t,x:()=>a});var i=s(96540);const r={},l=i.createContext(r);function t(n){const e=i.useContext(l);return i.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:t(n.components),i.createElement(l.Provider,{value:e},n.children)}}}]);