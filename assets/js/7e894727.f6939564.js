"use strict";(self.webpackChunkimdeepmind=self.webpackChunkimdeepmind||[]).push([[9356],{45297:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>t,default:()=>h,frontMatter:()=>c,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"databases/database-engineering/locks","title":"Locks","description":"This note is complete, reviewed, and considered stable.","source":"@site/docs/databases/database-engineering/locks.md","sourceDirName":"databases/database-engineering","slug":"/databases/database-engineering/locks","permalink":"/docs/databases/database-engineering/locks","draft":false,"unlisted":false,"editUrl":"https://github.com/imdeepmind/imdeepmind.github.io/blob/main/docs/databases/database-engineering/locks.md","tags":[],"version":"current","lastUpdatedBy":"Abhishek Chatterjee","lastUpdatedAt":1768666003000,"sidebarPosition":5,"frontMatter":{"sidebar_position":5},"sidebar":"tutorialSidebar","previous":{"title":"ACID","permalink":"/docs/databases/database-engineering/acid"},"next":{"title":"Indexes","permalink":"/docs/databases/database-engineering/indexes"}}');var l=i(74848),r=i(28453);const c={sidebar_position:5},t="Locks",a={},o=[{value:"Concurrency Control Overview",id:"concurrency-control-overview",level:2},{value:"ACID Properties Relation",id:"acid-properties-relation",level:2},{value:"Transactions and Lock Scope",id:"transactions-and-lock-scope",level:2},{value:"Lock Granularity",id:"lock-granularity",level:2},{value:"Database Level",id:"database-level",level:3},{value:"Table Level",id:"table-level",level:3},{value:"Page Level",id:"page-level",level:3},{value:"Row Level",id:"row-level",level:3},{value:"Granularity Hierarchy",id:"granularity-hierarchy",level:4},{value:"Lock Types and Modes",id:"lock-types-and-modes",level:2},{value:"Shared Locks (S)",id:"shared-locks-s",level:3},{value:"Exclusive Locks (X)",id:"exclusive-locks-x",level:3},{value:"Intent Locks",id:"intent-locks",level:3},{value:"Update Locks (U)",id:"update-locks-u",level:3},{value:"Schema Locks",id:"schema-locks",level:3},{value:"Lock Compatibility",id:"lock-compatibility",level:2},{value:"Compatibility Matrix",id:"compatibility-matrix",level:3},{value:"Lock Acquisition Rules",id:"lock-acquisition-rules",level:3},{value:"Multi-Granularity Locking",id:"multi-granularity-locking",level:3},{value:"Acquisition Strategies",id:"acquisition-strategies",level:2},{value:"Two-Phase Locking (2PL)",id:"two-phase-locking-2pl",level:3},{value:"Three-Phase Locking (3PL)",id:"three-phase-locking-3pl",level:3},{value:"Lock Escalation",id:"lock-escalation",level:3},{value:"Deadlock Prevention",id:"deadlock-prevention",level:3},{value:"Lock Management",id:"lock-management",level:2},{value:"Acquisition and Release",id:"acquisition-and-release",level:3},{value:"Lock Timeouts",id:"lock-timeouts",level:3},{value:"Lock Waiting Queues",id:"lock-waiting-queues",level:3},{value:"Lock Monitoring Queries",id:"lock-monitoring-queries",level:3},{value:"Problems and Solutions",id:"problems-and-solutions",level:2},{value:"Blocking Transactions",id:"blocking-transactions",level:3},{value:"Deadlocks (Detection/Resolution)",id:"deadlocks-detectionresolution",level:3},{value:"Livelocks",id:"livelocks",level:3},{value:"Starvation",id:"starvation",level:3},{value:"PostgreSQL Implementation",id:"postgresql-implementation",level:2},{value:"MVCC Integration",id:"mvcc-integration",level:3},{value:"Lock Modes (AccessShare to AccessExclusive)",id:"lock-modes-accessshare-to-accessexclusive",level:3},{value:"pg_locks System View",id:"pg_locks-system-view",level:3},{value:"Explicit Locking Commands",id:"explicit-locking-commands",level:3},{value:"PostgreSQL Internals",id:"postgresql-internals",level:2},{value:"LockManager Architecture",id:"lockmanager-architecture",level:3},{value:"Hash Table Storage",id:"hash-table-storage",level:3},{value:"Lightweight Locks",id:"lightweight-locks",level:3},{value:"Advisory Locks",id:"advisory-locks",level:3},{value:"Wait Graph Analysis",id:"wait-graph-analysis",level:3},{value:"Backend Lock Handling",id:"backend-lock-handling",level:3},{value:"Advanced Topics",id:"advanced-topics",level:2},{value:"Predicate vs Key-Range Locks",id:"predicate-vs-key-range-locks",level:3},{value:"Lock-Free Alternatives",id:"lock-free-alternatives",level:3},{value:"Distributed Locks",id:"distributed-locks",level:3},{value:"Performance Tuning",id:"performance-tuning",level:3}];function d(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"locks",children:"Locks"})}),"\n",(0,l.jsx)(n.admonition,{title:"Status",type:"tip",children:(0,l.jsx)(n.p,{children:"This note is complete, reviewed, and considered stable."})}),"\n",(0,l.jsxs)(n.p,{children:["In multi-user database systems, multiple transactions execute concurrently to maximize throughput and resource utilization. Locks exist to ",(0,l.jsx)(n.strong,{children:"coordinate concurrent access to shared data"})," so that correctness is preserved. Without locks, concurrent reads and writes could corrupt data or expose inconsistent intermediate states."]}),"\n",(0,l.jsx)(n.p,{children:"Locks primarily protect against the following anomalies:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Lost updates"})," \u2013 one transaction overwrites another\u2019s changes"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Dirty reads"})," \u2013 reading uncommitted data"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Non-repeatable reads"})," \u2013 re-reading yields different results"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Phantom reads"})," \u2013 new rows appear between reads"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["Conceptually, a lock is a ",(0,l.jsx)(n.strong,{children:"contract"})," between a transaction and the database engine that grants controlled access to a data item."]}),"\n",(0,l.jsx)(n.h2,{id:"concurrency-control-overview",children:"Concurrency Control Overview"}),"\n",(0,l.jsx)(n.p,{children:"Concurrency control ensures that the outcome of concurrent execution is equivalent to some serial execution (serializability)."}),"\n",(0,l.jsx)(n.p,{children:"Two dominant approaches:"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Lock-based concurrency control"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Transactions acquire locks before accessing data"}),"\n",(0,l.jsx)(n.li,{children:"Conflicts are resolved by blocking or aborting transactions"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Optimistic / MVCC-based concurrency control"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Readers do not block writers"}),"\n",(0,l.jsx)(n.li,{children:"Conflicts are detected at commit time"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Locks are still essential even in MVCC systems for:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Writes"}),"\n",(0,l.jsx)(n.li,{children:"Schema changes"}),"\n",(0,l.jsx)(n.li,{children:"Certain isolation guarantees"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"acid-properties-relation",children:"ACID Properties Relation"}),"\n",(0,l.jsxs)(n.p,{children:["Locks are primarily tied to ",(0,l.jsx)(n.strong,{children:"Isolation"})," and ",(0,l.jsx)(n.strong,{children:"Consistency"}),", but they indirectly support all ACID properties."]}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"ACID Property"}),(0,l.jsx)(n.th,{children:"Role of Locks"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Atomicity"}),(0,l.jsx)(n.td,{children:"Prevents partial visibility of changes"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Consistency"}),(0,l.jsx)(n.td,{children:"Enforces integrity during concurrent updates"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Isolation"}),(0,l.jsx)(n.td,{children:"Core purpose of locks"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Durability"}),(0,l.jsx)(n.td,{children:"Locks ensure committed state is well-defined"})]})]})]}),"\n",(0,l.jsxs)(n.p,{children:["Isolation levels (Read Committed, Repeatable Read, Serializable) determine ",(0,l.jsx)(n.strong,{children:"how aggressively locks are used"}),"."]}),"\n",(0,l.jsx)(n.h2,{id:"transactions-and-lock-scope",children:"Transactions and Lock Scope"}),"\n",(0,l.jsx)(n.p,{children:"Locks are scoped to:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["A ",(0,l.jsx)(n.strong,{children:"transaction"})," (released on commit/rollback)"]}),"\n",(0,l.jsxs)(n.li,{children:["A ",(0,l.jsx)(n.strong,{children:"statement"})," (statement-level locks)"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Scope dimensions:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Object scope: row, page, table, database"}),"\n",(0,l.jsx)(n.li,{children:"Time scope: short-lived vs long-lived"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Long-running transactions dramatically increase lock contention and risk of blocking."}),"\n",(0,l.jsx)(n.h2,{id:"lock-granularity",children:"Lock Granularity"}),"\n",(0,l.jsxs)(n.p,{children:["Lock granularity defines ",(0,l.jsx)(n.strong,{children:"how much data a lock protects"}),"."]}),"\n",(0,l.jsx)(n.h3,{id:"database-level",children:"Database Level"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Locks the entire database"}),"\n",(0,l.jsx)(n.li,{children:"Rare, usually for maintenance operations"}),"\n",(0,l.jsx)(n.li,{children:"Highest contention, lowest overhead"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Use cases:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Backup"}),"\n",(0,l.jsx)(n.li,{children:"Restore"}),"\n",(0,l.jsx)(n.li,{children:"Global configuration changes"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"table-level",children:"Table Level"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Locks the entire table"}),"\n",(0,l.jsx)(n.li,{children:"Common for DDL and bulk operations"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Pros:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Simple"}),"\n",(0,l.jsx)(n.li,{children:"Low lock manager overhead"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Cons:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Poor concurrency"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"page-level",children:"Page Level"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Locks a fixed-size block (page) of data"}),"\n",(0,l.jsx)(n.li,{children:"Balance between concurrency and overhead"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Often used internally by storage engines where row-level locks are too expensive."}),"\n",(0,l.jsx)(n.h3,{id:"row-level",children:"Row Level"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Locks individual rows"}),"\n",(0,l.jsx)(n.li,{children:"Highest concurrency"}),"\n",(0,l.jsx)(n.li,{children:"Highest lock bookkeeping cost"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Used heavily in OLTP systems."}),"\n",(0,l.jsx)(n.h4,{id:"granularity-hierarchy",children:"Granularity Hierarchy"}),"\n",(0,l.jsx)("div",{style:{textAlign:"center"},children:(0,l.jsx)(n.mermaid,{value:"graph TD\n    DB[Database Lock]\n    T[Table Lock]\n    P[Page Lock]\n    R[Row Lock]\n\n    DB --\x3e T\n    T --\x3e P\n    P --\x3e R"})}),"\n",(0,l.jsx)(n.h2,{id:"lock-types-and-modes",children:"Lock Types and Modes"}),"\n",(0,l.jsx)(n.h3,{id:"shared-locks-s",children:"Shared Locks (S)"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Allows multiple readers"}),"\n",(0,l.jsx)(n.li,{children:"Prevents writers"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Used for SELECT queries under stronger isolation levels."}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Example:"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- Transaction 1\nBEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;\nSELECT * FROM users WHERE id = 1;  -- Acquires S lock on row\n\n-- Transaction 2\nBEGIN TRANSACTION;\nSELECT * FROM users WHERE id = 1;  -- Can acquire S lock (compatible)\nUPDATE users SET name = 'Jane' WHERE id = 1;  -- Blocked (X lock incompatible with S)\n"})}),"\n",(0,l.jsx)(n.h3,{id:"exclusive-locks-x",children:"Exclusive Locks (X)"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Allows a single writer"}),"\n",(0,l.jsx)(n.li,{children:"Blocks all other access"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Required for UPDATE, DELETE, INSERT."}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Example:"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- Transaction 1\nBEGIN TRANSACTION;\nUPDATE users SET name = 'John' WHERE id = 1;  -- Acquires X lock on row\n\n-- Transaction 2 (blocked)\nBEGIN TRANSACTION;\nSELECT * FROM users WHERE id = 1;  -- Blocked waiting for X lock release\nUPDATE users SET age = 30 WHERE id = 1;  -- Blocked (X locks are mutually exclusive)\n"})}),"\n",(0,l.jsx)(n.h3,{id:"intent-locks",children:"Intent Locks"}),"\n",(0,l.jsxs)(n.p,{children:["Intent locks signal ",(0,l.jsx)(n.strong,{children:"future locking intentions"})," at a finer granularity."]}),"\n",(0,l.jsx)(n.p,{children:"Examples:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"IS (Intent Shared) \u2013 indicates that shared locks will be acquired on child objects"}),"\n",(0,l.jsx)(n.li,{children:"IX (Intent Exclusive) \u2013 indicates that exclusive locks will be acquired on child objects"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"They enable efficient multi-granularity locking without requiring the database to check every child object."}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Example:"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- Transaction holding multiple row locks\nBEGIN TRANSACTION;\nLOCK TABLE users IN INTENT EXCLUSIVE MODE;  -- Table gets IX lock\nUPDATE users SET status = 'active' WHERE id IN (1, 2, 3);  -- Row-level X locks acquired\n"})}),"\n",(0,l.jsx)("div",{style:{textAlign:"center"},children:(0,l.jsx)(n.mermaid,{value:"graph LR\n    T[Table]\n    R1[Row 1]\n    R2[Row 2]\n\n    T --\x3e|IX| R1\n    T --\x3e|IX| R2"})}),"\n",(0,l.jsx)(n.h3,{id:"update-locks-u",children:"Update Locks (U)"}),"\n",(0,l.jsx)(n.p,{children:"Used to avoid deadlocks during read-modify-write cycles."}),"\n",(0,l.jsx)(n.p,{children:"Behavior:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Initially behaves like Shared (allows multiple readers)"}),"\n",(0,l.jsx)(n.li,{children:"Converts to Exclusive when the update happens"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Common in SQL Server-style engines."}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Example:"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- SQL Server: read-modify-write with U lock\nBEGIN TRANSACTION;\nSELECT * FROM accounts WHERE id = 1 WITH (UPDLOCK);  -- Acquires U lock\n-- Other transactions can read but cannot acquire U or X locks\nUPDATE accounts SET balance = balance - 100 WHERE id = 1;  -- Upgrades U to X\nCOMMIT;\n"})}),"\n",(0,l.jsx)(n.h3,{id:"schema-locks",children:"Schema Locks"}),"\n",(0,l.jsx)(n.p,{children:"Protect database metadata."}),"\n",(0,l.jsx)(n.p,{children:"Types:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Schema Stability (allows queries)"}),"\n",(0,l.jsx)(n.li,{children:"Schema Modification (blocks everything)"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"DDL statements rely heavily on schema locks."}),"\n",(0,l.jsx)(n.h2,{id:"lock-compatibility",children:"Lock Compatibility"}),"\n",(0,l.jsx)(n.p,{children:"Two locks are compatible if they can be held simultaneously on the same data object by different transactions."}),"\n",(0,l.jsx)(n.h3,{id:"compatibility-matrix",children:"Compatibility Matrix"}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"Requested \\ Held"}),(0,l.jsx)(n.th,{children:"S (Shared)"}),(0,l.jsx)(n.th,{children:"X (Exclusive)"}),(0,l.jsx)(n.th,{children:"IS (Intent Shared)"}),(0,l.jsx)(n.th,{children:"IX (Intent Exclusive)"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"S (Shared)"}),(0,l.jsx)(n.td,{children:"\u2713"}),(0,l.jsx)(n.td,{children:"\u2717"}),(0,l.jsx)(n.td,{children:"\u2713"}),(0,l.jsx)(n.td,{children:"\u2717"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"X (Exclusive)"}),(0,l.jsx)(n.td,{children:"\u2717"}),(0,l.jsx)(n.td,{children:"\u2717"}),(0,l.jsx)(n.td,{children:"\u2717"}),(0,l.jsx)(n.td,{children:"\u2717"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"IS (Intent Shared)"}),(0,l.jsx)(n.td,{children:"\u2713"}),(0,l.jsx)(n.td,{children:"\u2717"}),(0,l.jsx)(n.td,{children:"\u2713"}),(0,l.jsx)(n.td,{children:"\u2713"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"IX (Intent Exclusive)"}),(0,l.jsx)(n.td,{children:"\u2717"}),(0,l.jsx)(n.td,{children:"\u2717"}),(0,l.jsx)(n.td,{children:"\u2713"}),(0,l.jsx)(n.td,{children:"\u2713"})]})]})]}),"\n",(0,l.jsx)(n.h3,{id:"lock-acquisition-rules",children:"Lock Acquisition Rules"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Stronger locks cannot be granted if weaker incompatible locks exist"}),"\n",(0,l.jsx)(n.li,{children:"Upgrades must re-check compatibility against all existing locks"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Lock upgrades are a frequent source of deadlocks because they can create wait-for cycles."}),"\n",(0,l.jsx)(n.h3,{id:"multi-granularity-locking",children:"Multi-Granularity Locking"}),"\n",(0,l.jsx)(n.p,{children:"Transactions lock higher-level objects with intent locks before locking finer objects."}),"\n",(0,l.jsx)("div",{style:{textAlign:"center"},children:(0,l.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant Tx as Transaction\n    participant T as Table\n    participant R as Row\n\n    Tx->>T: Acquire IX\n    Tx->>R: Acquire X"})}),"\n",(0,l.jsx)(n.h2,{id:"acquisition-strategies",children:"Acquisition Strategies"}),"\n",(0,l.jsx)(n.h3,{id:"two-phase-locking-2pl",children:"Two-Phase Locking (2PL)"}),"\n",(0,l.jsx)(n.p,{children:"Phases:"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Growing phase"})," \u2013 acquire locks, no releases allowed"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Shrinking phase"})," \u2013 release locks, no acquisitions allowed"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Guarantees serializability when strictly enforced."}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Strict 2PL"})," releases locks only at transaction commit or rollback, ensuring no uncommitted changes are visible."]}),"\n",(0,l.jsx)(n.h3,{id:"three-phase-locking-3pl",children:"Three-Phase Locking (3PL)"}),"\n",(0,l.jsx)(n.p,{children:"Adds an intermediate phase to avoid blocking anomalies."}),"\n",(0,l.jsx)(n.p,{children:"Rarely used in real systems due to complexity."}),"\n",(0,l.jsx)(n.h3,{id:"lock-escalation",children:"Lock Escalation"}),"\n",(0,l.jsx)(n.p,{children:"Automatic promotion of many fine-grained locks into a coarser lock."}),"\n",(0,l.jsx)(n.p,{children:"Trade-off:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Reduced overhead"}),"\n",(0,l.jsx)(n.li,{children:"Reduced concurrency"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"deadlock-prevention",children:"Deadlock Prevention"}),"\n",(0,l.jsx)(n.p,{children:"Common strategies:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Timeout-based abort"})," \u2013 abort if wait exceeds threshold"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Wait-die"})," \u2013 older transactions wait for newer ones; younger transactions die and retry"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Wound-wait"})," \u2013 older transactions preempt younger ones; younger transactions wait"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Each strategy balances fairness, throughput, and restart overhead differently."}),"\n",(0,l.jsx)(n.h2,{id:"lock-management",children:"Lock Management"}),"\n",(0,l.jsx)(n.h3,{id:"acquisition-and-release",children:"Acquisition and Release"}),"\n",(0,l.jsx)(n.p,{children:"Locks are:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Acquired on demand"}),"\n",(0,l.jsx)(n.li,{children:"Released at commit/rollback or earlier"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Incorrect release timing breaks isolation."}),"\n",(0,l.jsx)(n.h3,{id:"lock-timeouts",children:"Lock Timeouts"}),"\n",(0,l.jsx)(n.p,{children:"Transactions waiting beyond a configured threshold are automatically aborted."}),"\n",(0,l.jsx)(n.p,{children:"Prevents infinite waits but may abort valid long-running transactions under contention."}),"\n",(0,l.jsx)(n.h3,{id:"lock-waiting-queues",children:"Lock Waiting Queues"}),"\n",(0,l.jsx)(n.p,{children:"Blocked transactions wait in queues per lock object."}),"\n",(0,l.jsx)("div",{style:{textAlign:"center"},children:(0,l.jsx)(n.mermaid,{value:"graph TD\n    L[Lock]\n    T1[Tx1 Holding]\n    T2[Tx2 Waiting]\n    T3[Tx3 Waiting]\n\n    T1 --\x3e L\n    T2 --\x3e L\n    T3 --\x3e L"})}),"\n",(0,l.jsx)(n.h3,{id:"lock-monitoring-queries",children:"Lock Monitoring Queries"}),"\n",(0,l.jsx)(n.p,{children:"Databases expose system views for us to inspect:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Current locks held"}),"\n",(0,l.jsx)(n.li,{children:"Waiting transactions"}),"\n",(0,l.jsx)(n.li,{children:"Blocking chains"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Essential for diagnosing and debugging production contention issues."}),"\n",(0,l.jsx)(n.h2,{id:"problems-and-solutions",children:"Problems and Solutions"}),"\n",(0,l.jsx)(n.h3,{id:"blocking-transactions",children:"Blocking Transactions"}),"\n",(0,l.jsx)(n.p,{children:"Occurs when incompatible locks collide and one transaction must wait."}),"\n",(0,l.jsx)(n.p,{children:"Mitigation strategies:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Keep transactions short to minimize lock hold times"}),"\n",(0,l.jsx)(n.li,{children:"Use proper indexing to reduce the number of rows accessed"}),"\n",(0,l.jsx)(n.li,{children:"Optimize query execution plans"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"deadlocks-detectionresolution",children:"Deadlocks (Detection/Resolution)"}),"\n",(0,l.jsx)(n.p,{children:"Circular wait condition."}),"\n",(0,l.jsx)("div",{style:{textAlign:"center"},children:(0,l.jsx)(n.mermaid,{value:"graph LR\n    T1 --\x3e|waits| T2\n    T2 --\x3e|waits| T1"})}),"\n",(0,l.jsx)(n.p,{children:"Resolved by aborting one participant."}),"\n",(0,l.jsx)(n.h3,{id:"livelocks",children:"Livelocks"}),"\n",(0,l.jsx)(n.p,{children:"Transactions repeatedly abort and retry without progress, wasting resources."}),"\n",(0,l.jsx)(n.p,{children:"Solved via exponential backoff or priority-based scheduling adjustments."}),"\n",(0,l.jsx)(n.h3,{id:"starvation",children:"Starvation"}),"\n",(0,l.jsx)(n.p,{children:"Low-priority transactions never acquire locks."}),"\n",(0,l.jsx)(n.p,{children:"Solved via fairness policies."}),"\n",(0,l.jsx)(n.h2,{id:"postgresql-implementation",children:"PostgreSQL Implementation"}),"\n",(0,l.jsx)(n.h3,{id:"mvcc-integration",children:"MVCC Integration"}),"\n",(0,l.jsx)(n.p,{children:"PostgreSQL uses MVCC, so:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Reads do not block writes"}),"\n",(0,l.jsx)(n.li,{children:"Writes still require locks"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Locks coordinate visibility and structural safety."}),"\n",(0,l.jsx)(n.h3,{id:"lock-modes-accessshare-to-accessexclusive",children:"Lock Modes (AccessShare to AccessExclusive)"}),"\n",(0,l.jsx)(n.p,{children:"Ordered from weakest to strongest:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"AccessShare (SELECT)"}),"\n",(0,l.jsx)(n.li,{children:"RowShare"}),"\n",(0,l.jsx)(n.li,{children:"RowExclusive"}),"\n",(0,l.jsx)(n.li,{children:"ShareUpdateExclusive"}),"\n",(0,l.jsx)(n.li,{children:"Share"}),"\n",(0,l.jsx)(n.li,{children:"ShareRowExclusive"}),"\n",(0,l.jsx)(n.li,{children:"Exclusive"}),"\n",(0,l.jsx)(n.li,{children:"AccessExclusive (DDL)"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"pg_locks-system-view",children:"pg_locks System View"}),"\n",(0,l.jsx)(n.p,{children:"Provides visibility into:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Lock type"}),"\n",(0,l.jsx)(n.li,{children:"Lock mode"}),"\n",(0,l.jsx)(n.li,{children:"Granted vs waiting"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Critical for diagnosing contention."}),"\n",(0,l.jsx)(n.h3,{id:"explicit-locking-commands",children:"Explicit Locking Commands"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"LOCK TABLE users IN ACCESS EXCLUSIVE MODE;\n"})}),"\n",(0,l.jsx)(n.p,{children:"Used sparingly for critical sections."}),"\n",(0,l.jsx)(n.h2,{id:"postgresql-internals",children:"PostgreSQL Internals"}),"\n",(0,l.jsx)(n.h3,{id:"lockmanager-architecture",children:"LockManager Architecture"}),"\n",(0,l.jsx)(n.p,{children:"Centralized lock manager per instance."}),"\n",(0,l.jsx)(n.h3,{id:"hash-table-storage",children:"Hash Table Storage"}),"\n",(0,l.jsx)(n.p,{children:"Locks stored in shared memory hash tables keyed by object ID."}),"\n",(0,l.jsx)(n.h3,{id:"lightweight-locks",children:"Lightweight Locks"}),"\n",(0,l.jsx)(n.p,{children:"Protect internal data structures."}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Very fast"}),"\n",(0,l.jsx)(n.li,{children:"Not user-visible"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"advisory-locks",children:"Advisory Locks"}),"\n",(0,l.jsx)(n.p,{children:"Application-defined locks."}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Not tied to table rows"}),"\n",(0,l.jsx)(n.li,{children:"Used for coordination"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"wait-graph-analysis",children:"Wait Graph Analysis"}),"\n",(0,l.jsx)(n.p,{children:"Deadlock detector builds wait-for graphs periodically."}),"\n",(0,l.jsx)(n.h3,{id:"backend-lock-handling",children:"Backend Lock Handling"}),"\n",(0,l.jsx)(n.p,{children:"Each backend process:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Requests locks"}),"\n",(0,l.jsx)(n.li,{children:"Sleeps when blocked"}),"\n",(0,l.jsx)(n.li,{children:"Wakes on release"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"advanced-topics",children:"Advanced Topics"}),"\n",(0,l.jsx)(n.h3,{id:"predicate-vs-key-range-locks",children:"Predicate vs Key-Range Locks"}),"\n",(0,l.jsx)(n.p,{children:'Predicate locks protect logical conditions (e.g., "salary > 100000").\nKey-range locks protect physical index ranges and prevent phantom reads.'}),"\n",(0,l.jsx)(n.p,{children:"Serializable isolation levels rely on these mechanisms."}),"\n",(0,l.jsx)(n.h3,{id:"lock-free-alternatives",children:"Lock-Free Alternatives"}),"\n",(0,l.jsx)(n.p,{children:"Optimistic concurrency control avoids locks by detecting conflicts at commit time."}),"\n",(0,l.jsx)(n.p,{children:"Most effective when conflicts are rare and transaction throughput is a priority."}),"\n",(0,l.jsx)(n.h3,{id:"distributed-locks",children:"Distributed Locks"}),"\n",(0,l.jsx)(n.p,{children:"Required in distributed systems."}),"\n",(0,l.jsx)(n.p,{children:"Challenges:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Clock skew"}),"\n",(0,l.jsx)(n.li,{children:"Network partitions"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Examples:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"ZooKeeper"}),"\n",(0,l.jsx)(n.li,{children:"etcd"}),"\n",(0,l.jsx)(n.li,{children:"Redis Redlock"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"performance-tuning",children:"Performance Tuning"}),"\n",(0,l.jsx)(n.p,{children:"Best practices:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Keep transactions short"}),"\n",(0,l.jsx)(n.li,{children:"Index properly"}),"\n",(0,l.jsx)(n.li,{children:"Avoid unnecessary explicit locks"}),"\n",(0,l.jsx)(n.li,{children:"Monitor lock contention continuously"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(d,{...e})}):d(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>c,x:()=>t});var s=i(96540);const l={},r=s.createContext(l);function c(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:c(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);