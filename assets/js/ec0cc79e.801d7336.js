"use strict";(self.webpackChunkimdeepmind=self.webpackChunkimdeepmind||[]).push([[3828],{42730:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>a,contentTitle:()=>d,default:()=>o,frontMatter:()=>t,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"databases/sql/cte","title":"Common Table Expressions (CTEs)","description":"This note is complete, reviewed, and considered stable.","source":"@site/docs/databases/sql/cte.md","sourceDirName":"databases/sql","slug":"/databases/sql/cte","permalink":"/docs/databases/sql/cte","draft":false,"unlisted":false,"editUrl":"https://github.com/imdeepmind/imdeepmind.github.io/blob/main/docs/databases/sql/cte.md","tags":[],"version":"current","lastUpdatedBy":"Abhishek Chatterjee","lastUpdatedAt":1767097969000,"sidebarPosition":8,"frontMatter":{"sidebar_position":8},"sidebar":"tutorialSidebar","previous":{"title":"Subqueries and Nested Queries","permalink":"/docs/databases/sql/subqueries"},"next":{"title":"Window Functions","permalink":"/docs/databases/sql/window-functions"}}');var r=n(74848),l=n(28453);const t={sidebar_position:8},d="Common Table Expressions (CTEs)",a={},c=[{value:"Basic Syntax",id:"basic-syntax",level:2},{value:"Example 1: Simple CTE",id:"example-1-simple-cte",level:3},{value:"Example 2: Multiple CTEs",id:"example-2-multiple-ctes",level:3},{value:"Example 3: Recursive CTE",id:"example-3-recursive-cte",level:3},{value:"Advantages of CTEs",id:"advantages-of-ctes",level:2},{value:"When to Use Joins, Subqueries, and CTEs",id:"when-to-use-joins-subqueries-and-ctes",level:2},{value:"Database Optimization Notes",id:"database-optimization-notes",level:2},{value:"Key Takeaways",id:"key-takeaways",level:2}];function h(e){const s={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.header,{children:(0,r.jsx)(s.h1,{id:"common-table-expressions-ctes",children:"Common Table Expressions (CTEs)"})}),"\n",(0,r.jsx)(s.admonition,{title:"Status",type:"tip",children:(0,r.jsx)(s.p,{children:"This note is complete, reviewed, and considered stable."})}),"\n",(0,r.jsxs)(s.p,{children:["A ",(0,r.jsx)(s.strong,{children:"Common Table Expression (CTE)"})," is a ",(0,r.jsx)(s.strong,{children:"temporary named result set"})," that exists only during the execution of a single SQL statement.\nCTEs improve query readability, allow for recursive queries, and can simplify complex queries that would otherwise require nested subqueries or derived tables. They're one of our favorite tools for making SQL more readable!"]}),"\n",(0,r.jsx)(s.h2,{id:"basic-syntax",children:"Basic Syntax"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-sql",children:"WITH cte_name AS (\n    SELECT column1, column2\n    FROM table_name\n    WHERE condition\n)\nSELECT *\nFROM cte_name\nWHERE another_condition;\n"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Explanation:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"WITH"})," introduces the CTE."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"cte_name"})," is the temporary name for the result set."]}),"\n",(0,r.jsxs)(s.li,{children:["The CTE can then be referenced in the main ",(0,r.jsx)(s.code,{children:"SELECT"})," query as if it were a table - pretty neat!"]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"example-1-simple-cte",children:"Example 1: Simple CTE"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Tables:"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.code,{children:"employees"})}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"employee_id"}),(0,r.jsx)(s.th,{children:"name"}),(0,r.jsx)(s.th,{children:"department_id"}),(0,r.jsx)(s.th,{children:"salary"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"1"}),(0,r.jsx)(s.td,{children:"Alice"}),(0,r.jsx)(s.td,{children:"101"}),(0,r.jsx)(s.td,{children:"70000"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"2"}),(0,r.jsx)(s.td,{children:"Bob"}),(0,r.jsx)(s.td,{children:"102"}),(0,r.jsx)(s.td,{children:"80000"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"3"}),(0,r.jsx)(s.td,{children:"Charlie"}),(0,r.jsx)(s.td,{children:"101"}),(0,r.jsx)(s.td,{children:"60000"})]})]})]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Goal:"})," Find employees earning more than the average salary."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-sql",children:"WITH avg_salary AS (\n    SELECT AVG(salary) AS avg_sal\n    FROM employees\n)\nSELECT name, salary\nFROM employees, avg_salary\nWHERE salary > avg_salary.avg_sal;\n"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Output:"})}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"name"}),(0,r.jsx)(s.th,{children:"salary"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Bob"}),(0,r.jsx)(s.td,{children:"80000"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Alice"}),(0,r.jsx)(s.td,{children:"70000"})]})]})]}),"\n",(0,r.jsx)("div",{style:{textAlign:"center"},children:(0,r.jsx)(s.mermaid,{value:"graph TD\nA[employees table] --\x3e B[avg_salary CTE]\nB --\x3e C[Final SELECT filters salary > avg_salary]"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Explanation:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["The CTE ",(0,r.jsx)(s.code,{children:"avg_salary"})," calculates a single value."]}),"\n",(0,r.jsx)(s.li,{children:"The main query references it for filtering, making the query way clearer than a nested subquery would be."}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"example-2-multiple-ctes",children:"Example 2: Multiple CTEs"}),"\n",(0,r.jsxs)(s.p,{children:["We can define ",(0,r.jsx)(s.strong,{children:"multiple CTEs"})," in a single query."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-sql",children:"WITH dept_avg AS (\n    SELECT department_id, AVG(salary) AS avg_sal\n    FROM employees\n    GROUP BY department_id\n),\nhigh_earners AS (\n    SELECT e.name, e.salary, e.department_id\n    FROM employees e\n    JOIN dept_avg d\n    ON e.department_id = d.department_id\n    WHERE e.salary > d.avg_sal\n)\nSELECT *\nFROM high_earners;\n"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Output:"})}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"name"}),(0,r.jsx)(s.th,{children:"salary"}),(0,r.jsx)(s.th,{children:"department_id"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Alice"}),(0,r.jsx)(s.td,{children:"70000"}),(0,r.jsx)(s.td,{children:"101"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Bob"}),(0,r.jsx)(s.td,{children:"80000"}),(0,r.jsx)(s.td,{children:"102"})]})]})]}),"\n",(0,r.jsx)("div",{style:{textAlign:"center"},children:(0,r.jsx)(s.mermaid,{value:"graph TD\nA[employees] --\x3e B[dept_avg CTE]\nB --\x3e C[high_earners CTE joins dept_avg]\nC --\x3e D[Final SELECT]"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Explanation:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"First CTE calculates department average salary."}),"\n",(0,r.jsx)(s.li,{children:"Second CTE filters employees above department average."}),"\n",(0,r.jsx)(s.li,{children:"Main query selects from the second CTE."}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Readability and modularity"})," are greatly improved - we can build complex queries step by step!"]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"example-3-recursive-cte",children:"Example 3: Recursive CTE"}),"\n",(0,r.jsx)(s.p,{children:"Recursive CTEs reference themselves. Useful for hierarchical data, e.g., organizational charts."}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsxs)(s.strong,{children:["Table: ",(0,r.jsx)(s.code,{children:"employees"})," (manager hierarchy)"]})}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"employee_id"}),(0,r.jsx)(s.th,{children:"name"}),(0,r.jsx)(s.th,{children:"manager_id"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"1"}),(0,r.jsx)(s.td,{children:"Alice"}),(0,r.jsx)(s.td,{children:"NULL"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"2"}),(0,r.jsx)(s.td,{children:"Bob"}),(0,r.jsx)(s.td,{children:"1"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"3"}),(0,r.jsx)(s.td,{children:"Charlie"}),(0,r.jsx)(s.td,{children:"2"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"4"}),(0,r.jsx)(s.td,{children:"David"}),(0,r.jsx)(s.td,{children:"2"})]})]})]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Goal:"})," Get all employees under manager Alice."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-sql",children:"WITH RECURSIVE subordinates AS (\n    SELECT employee_id, name, manager_id\n    FROM employees\n    WHERE manager_id IS NULL  -- Alice\n\n    UNION ALL\n\n    SELECT e.employee_id, e.name, e.manager_id\n    FROM employees e\n    INNER JOIN subordinates s\n    ON e.manager_id = s.employee_id\n)\nSELECT *\nFROM subordinates;\n"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Output:"})}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"employee_id"}),(0,r.jsx)(s.th,{children:"name"}),(0,r.jsx)(s.th,{children:"manager_id"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"1"}),(0,r.jsx)(s.td,{children:"Alice"}),(0,r.jsx)(s.td,{children:"NULL"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"2"}),(0,r.jsx)(s.td,{children:"Bob"}),(0,r.jsx)(s.td,{children:"1"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"3"}),(0,r.jsx)(s.td,{children:"Charlie"}),(0,r.jsx)(s.td,{children:"2"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"4"}),(0,r.jsx)(s.td,{children:"David"}),(0,r.jsx)(s.td,{children:"2"})]})]})]}),"\n",(0,r.jsx)("div",{style:{textAlign:"center"},children:(0,r.jsx)(s.mermaid,{value:"graph TD\nA[Alice] --\x3e B[Bob]\nB --\x3e C[Charlie]\nB --\x3e D[David]"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Explanation:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Recursive CTE starts with the anchor member (Alice)."}),"\n",(0,r.jsx)(s.li,{children:"Recursively joins to find subordinates at all levels - this is super powerful for hierarchical data!"}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"advantages-of-ctes",children:"Advantages of CTEs"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Improved Readability:"}),"\nBreak complex queries into named steps."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Reusable within Query:"}),"\nThe CTE name can be referenced multiple times."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Supports Recursion:"}),"\nUseful for hierarchical data."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Better than nested subqueries:"}),"\nSimplifies complex filtering, aggregation, or joins."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"when-to-use-joins-subqueries-and-ctes",children:"When to Use Joins, Subqueries, and CTEs"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Operation"}),(0,r.jsx)(s.th,{children:"When to Use"}),(0,r.jsx)(s.th,{children:"Notes"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"JOIN"})}),(0,r.jsx)(s.td,{children:"Combining columns from multiple tables in a single query."}),(0,r.jsx)(s.td,{children:"Efficient for large datasets; supported in all databases."})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"Subquery"})}),(0,r.jsx)(s.td,{children:"Filtering based on aggregated or conditional values; existence checks; single-step computations."}),(0,r.jsx)(s.td,{children:"Can be correlated (row-by-row) or nested."})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"CTE"})}),(0,r.jsx)(s.td,{children:"Breaking complex queries into readable steps; recursive hierarchies; multiple references to same intermediate result."}),(0,r.jsx)(s.td,{children:"Optimized by the query planner; makes query maintenance easier."})]})]})]}),"\n",(0,r.jsx)(s.h2,{id:"database-optimization-notes",children:"Database Optimization Notes"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Feature"}),(0,r.jsx)(s.th,{children:"PostgreSQL"}),(0,r.jsx)(s.th,{children:"MySQL"}),(0,r.jsx)(s.th,{children:"SQL Server"}),(0,r.jsx)(s.th,{children:"Oracle"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"JOIN optimization"})}),(0,r.jsx)(s.td,{children:"Uses hash join, merge join, nested loop; well-optimized"}),(0,r.jsx)(s.td,{children:"Similar; uses nested loops or hash joins"}),(0,r.jsx)(s.td,{children:"Uses cost-based optimizer; multiple join strategies"}),(0,r.jsx)(s.td,{children:"Similar; cost-based optimizer"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"Subquery optimization"})}),(0,r.jsx)(s.td,{children:"Can convert to JOIN internally for efficiency"}),(0,r.jsx)(s.td,{children:"Correlated subqueries may be slow; sometimes optimized to JOIN"}),(0,r.jsx)(s.td,{children:"Correlated subqueries optimized to JOIN"}),(0,r.jsx)(s.td,{children:"Similar; optimizer can flatten subqueries"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"CTE optimization"})}),(0,r.jsx)(s.td,{children:"Non-recursive CTE may be inlined"}),(0,r.jsx)(s.td,{children:"Non-recursive CTE inlined (MySQL 8+)"}),(0,r.jsx)(s.td,{children:"Non-recursive CTE inlined"}),(0,r.jsx)(s.td,{children:"Non-recursive CTE inlined; recursive executed iteratively"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"Recursive CTE"})}),(0,r.jsx)(s.td,{children:"Well-supported; optimized"}),(0,r.jsx)(s.td,{children:"Supported from 8.0; can be slower on large data"}),(0,r.jsx)(s.td,{children:"Supported; optimized"}),(0,r.jsx)(s.td,{children:"Supported; can handle large hierarchies"})]})]})]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Note:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Non-recursive CTEs are often ",(0,r.jsx)(s.strong,{children:"just syntactic sugar"})," for derived tables; performance is similar to subqueries."]}),"\n",(0,r.jsx)(s.li,{children:"Recursive CTEs are unique; they are optimized differently than joins or subqueries."}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"key-takeaways",children:"Key Takeaways"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"CTEs"})," are temporary result sets that improve query clarity and structure."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Recursive CTEs"})," are ideal for hierarchical data."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Subqueries"})," are better for filtered or aggregated computations."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Joins"})," are most efficient for combining tables."]}),"\n",(0,r.jsxs)(s.li,{children:["Use ",(0,r.jsx)(s.strong,{children:"CTEs"})," when queries are complex, reused multiple times, or require recursion."]}),"\n",(0,r.jsx)(s.li,{children:"Databases optimize these differently: CTEs are usually inlined, subqueries may be flattened into joins, and recursive CTEs are iteratively evaluated."}),"\n"]})]})}function o(e={}){const{wrapper:s}={...(0,l.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},28453:(e,s,n)=>{n.d(s,{R:()=>t,x:()=>d});var i=n(96540);const r={},l=i.createContext(r);function t(e){const s=i.useContext(l);return i.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function d(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),i.createElement(l.Provider,{value:s},e.children)}}}]);